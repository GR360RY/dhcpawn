!function(root,factory){"undefined"!=typeof exports?module.exports=factory(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],factory):factory(root._,root.Backbone)}(this,function(_,Backbone){function _super(instance,method,args){return instance._super.prototype[method].apply(instance,args)}function deepModelSet(model,toSet,toReturn,stack){for(var attribute in toSet)if(toSet.hasOwnProperty(attribute)){var value=toSet[attribute];if(model.hasComputed(attribute)){if(stack.length&&_.contains(stack,attribute))throw"Recursive setter: "+stack.join(" > ");value=model.c()[attribute].set(value),value&&isObject(value)&&(toReturn=deepModelSet(model,value,toReturn,stack.concat(attribute)))}else toReturn[attribute]=value}return toReturn}function EpoxyComputedModel(model,name,params,delayInit){params=params||{},params.get&&isFunction(params.get)&&(params._get=params.get),params.set&&isFunction(params.set)&&(params._set=params.set),delete params.get,delete params.set,_.extend(this,params),this.model=model,this.name=name,this.deps=this.deps||[],delayInit||this.init()}function readAccessor(accessor){return isFunction(accessor)?accessor():(isObject(accessor)&&(accessor=_.clone(accessor),_.each(accessor,function(value,key){accessor[key]=readAccessor(value)})),accessor)}function makeHandler(handler){return isFunction(handler)?{set:handler}:handler}function makeFilter(handler){return function(){var params=arguments,read=isFunction(handler)?handler:handler.get,write=handler.set;return function(value){return isUndefined(value)?read.apply(this,_.map(params,readAccessor)):params[0]((write?write:read).call(this,value))}}}function addSourceToViewContext(source,context,options,name,prefix){return(source=_.result(source,name))?(isModel(source)?(prefix=prefix?prefix+"_":"",context["$"+name]=function(){return viewMap&&viewMap.push([source,"change"]),source},_.each(source.toJSON({computed:!0}),function(value,attribute){context[prefix+attribute]=function(value){return accessViewDataAttribute(source,attribute,value,options)}})):isCollection(source)&&(context["$"+name]=function(){return viewMap&&viewMap.push([source,"reset add remove sort update"]),source}),source):void 0}function accessViewDataAttribute(source,attribute,value,options){if(viewMap&&viewMap.push([source,"change:"+attribute]),!isUndefined(value)){if(!isObject(value)||isArray(value)||_.isDate(value)){var val=value;value={},value[attribute]=val}return options&&options.save?source.save(value,options):source.set(value,options)}return source.get(attribute)}function queryViewForSelector(view,selector){if(":el"===selector)return view.$el;var $elements=view.$(selector);return view.$el.is(selector)&&($elements=$elements.add(view.$el)),$elements}function bindElementToView(view,$element,declarations,context,handlers,filters){try{var parserFunct=bindingCache[declarations]||(bindingCache[declarations]=new Function("$f","$c","with($f){with($c){return{"+declarations+"}}}")),bindings=parserFunct(filters,context)}catch(error){throw'Error parsing bindings: "'+declarations+'"\n>> '+error}var events=_.map(_.union(bindings.events||[],["change"]),function(name){return name+".epoxy"}).join(" ");_.each(bindings,function(accessor,handlerName){if(handlers.hasOwnProperty(handlerName))view.b().push(new EpoxyBinding(view,$element,handlers[handlerName],accessor,events,context,bindings));else if(!allowedParams.hasOwnProperty(handlerName))throw'binding handler "'+handlerName+'" is not defined.'})}function accessViewContext(context,attribute,value){return context&&context.hasOwnProperty(attribute)?isUndefined(value)?readAccessor(context[attribute]):context[attribute](value):void 0}function getDepsFromViewContext(context,attributes){var values=[];if(attributes&&context)for(var i=0,len=attributes.length;len>i;i++)values.push(attributes[i]in context?context[attributes[i]]():null);return values}function EpoxyBinding(view,$element,handler,accessor,events,context,bindings){var self=this,tag=$element[0].tagName.toLowerCase(),changable="input"==tag||"select"==tag||"textarea"==tag||"true"==$element.prop("contenteditable"),triggers=[],reset=function(target){self.$el&&self.set(self.$el,readAccessor(accessor),target)};if(self.view=view,self.$el=$element,self.evt=events,_.extend(self,handler),accessor=self.init(self.$el,readAccessor(accessor),context,bindings)||accessor,viewMap=triggers,reset(),viewMap=null,changable&&handler.get&&isFunction(accessor)&&self.$el.on(events,function(evt){accessor(self.get(self.$el,readAccessor(accessor),evt))}),triggers.length)for(var i=0,len=triggers.length;len>i;i++)self.listenTo(triggers[i][0],triggers[i][1],reset)}var modelMap,Epoxy=Backbone.Epoxy={},array=Array.prototype,isUndefined=_.isUndefined,isFunction=_.isFunction,isObject=_.isObject,isArray=_.isArray,isModel=function(obj){return obj instanceof Backbone.Model},isCollection=function(obj){return obj instanceof Backbone.Collection},blankMethod=function(){},mixins={mixin:function(extend){extend=extend||{};for(var i in this.prototype)"bindings"===i&&extend.bindings||this.prototype.hasOwnProperty(i)&&"constructor"!==i&&(extend[i]=this.prototype[i]);return extend}},modelProps=["computeds"];Epoxy.Model=Backbone.Model.extend({_super:Backbone.Model,constructor:function(attributes,options){_.extend(this,_.pick(options||{},modelProps)),_super(this,"constructor",arguments),this.initComputeds(attributes,options)},getCopy:function(attribute){return _.clone(this.get(attribute))},get:function(attribute){return modelMap&&modelMap.push(["change:"+attribute,this]),this.hasComputed(attribute)?this.c()[attribute].get():_super(this,"get",arguments)},set:function(key,value,options){var params=key;params&&!isObject(params)?(params={},params[key]=value):options=value,options=options||{};var computedEvents=this._setting=[];options.unset||(params=deepModelSet(this,params,{},[])),delete this._setting;var result=_super(this,"set",[params,options]);return options.silent||(!this.hasChanged()&&computedEvents.length&&this.trigger("change",this),_.each(computedEvents,function(evt){this.trigger.apply(this,evt)},this)),result},toJSON:function(options){var json=_super(this,"toJSON",arguments);return options&&options.computed&&_.each(this.c(),function(computed,attribute){json[attribute]=computed.value}),json},destroy:function(){return this.clearComputeds(),_super(this,"destroy",arguments)},c:function(){return this._c||(this._c={})},initComputeds:function(attributes,options){this.clearComputeds();var computeds=_.result(this,"computeds")||{};computeds=_.extend(computeds,_.pick(attributes||{},_.keys(computeds))),_.each(computeds,function(params,attribute){params._init=1,this.addComputed(attribute,params)},this),_.invoke(this.c(),"init")},addComputed:function(attribute,getter,setter){this.removeComputed(attribute);var params=getter,delayInit=params._init;if(isFunction(getter)){var depsIndex=2;params={},params._get=getter,isFunction(setter)&&(params._set=setter,depsIndex++),params.deps=array.slice.call(arguments,depsIndex)}return this.c()[attribute]=new EpoxyComputedModel(this,attribute,params,delayInit),this},hasComputed:function(attribute){return this.c().hasOwnProperty(attribute)},removeComputed:function(attribute){return this.hasComputed(attribute)&&(this.c()[attribute].dispose(),delete this.c()[attribute]),this},clearComputeds:function(){for(var attribute in this.c())this.removeComputed(attribute);return this},modifyArray:function(attribute,method,options){var obj=this.get(attribute);if(isArray(obj)&&isFunction(array[method])){var args=array.slice.call(arguments,2),result=array[method].apply(obj,args);return options=options||{},options.silent||this.trigger("change:"+attribute+" change",this,array,options),result}return null},modifyObject:function(attribute,property,value,options){var obj=this.get(attribute),change=!1;return isObject(obj)?(options=options||{},isUndefined(value)&&obj.hasOwnProperty(property)?(delete obj[property],change=!0):obj[property]!==value&&(obj[property]=value,change=!0),change&&!options.silent&&this.trigger("change:"+attribute+" change",this,obj,options),obj):null}},mixins),_.extend(EpoxyComputedModel.prototype,Backbone.Events,{init:function(){var bindings={},deps=modelMap=[];this.get(!0),modelMap=null,deps.length&&(_.each(deps,function(value){var attribute=value[0],target=value[1];bindings[attribute]?_.contains(bindings[attribute],target)||bindings[attribute].push(target):bindings[attribute]=[target]}),_.each(bindings,function(targets,binding){for(var i=0,len=targets.length;len>i;i++)this.listenTo(targets[i],binding,_.bind(this.get,this,!0))},this))},val:function(attribute){return this.model.get(attribute)},get:function(update){if(update===!0&&this._get){var val=this._get.apply(this.model,_.map(this.deps,this.val,this));this.change(val)}return this.value},set:function(val){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed attribute."}return this.change(val),null},change:function(value){if(!_.isEqual(value,this.value)){this.value=value;var evt=["change:"+this.name,this.model,value];this.model._setting?this.model._setting.push(evt):(evt[0]+=" change",this.model.trigger.apply(this.model,evt))}},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var bindingSettings={optionText:"label",optionValue:"value"},bindingCache={},bindingHandlers={attr:makeHandler(function($element,value){$element.attr(value)}),checked:makeHandler({get:function($element,currentValue){var checked=!!$element.prop("checked"),value=$element.val();if(this.isRadio($element))return value;if(isArray(currentValue)){currentValue=currentValue.slice();var index=_.indexOf(currentValue,value);return checked&&0>index?currentValue.push(value):!checked&&index>-1&&currentValue.splice(index,1),currentValue}return checked},set:function($element,value){var checked=!!value;this.isRadio($element)?checked=value==$element.val():isArray(value)&&(checked=_.contains(value,$element.val())),$element.prop("checked",checked)},isRadio:function($element){return"radio"===$element.attr("type").toLowerCase()}}),classes:makeHandler(function($element,value){_.each(value,function(enabled,className){$element.toggleClass(className,!!enabled)})}),collection:makeHandler({init:function($element,collection,context,bindings){if(this.i=bindings.itemView?this.view[bindings.itemView]:this.view.itemView,!isCollection(collection))throw'Binding "collection" requires a Collection.';if(!isFunction(this.i))throw'Binding "collection" requires an itemView.';this.v={}},set:function($element,collection,target){var view,views=this.v,ItemView=this.i,models=collection.models,mapCache=viewMap;if(viewMap=null,target=target||collection,isModel(target))if(views.hasOwnProperty(target.cid))views[target.cid].remove(),delete views[target.cid];else{views[target.cid]=view=new ItemView({model:target,collectionView:this.view});var index=_.indexOf(models,target),$children=$element.children();index<$children.length?$children.eq(index).before(view.$el):$element.append(view.$el)}else if(isCollection(target)){var sort=models.length===_.size(views)&&collection.every(function(model){return views.hasOwnProperty(model.cid)});$element.children().detach();var frag=document.createDocumentFragment();sort?collection.each(function(model){frag.appendChild(views[model.cid].el)}):(this.clean(),collection.each(function(model){views[model.cid]=view=new ItemView({model:model,collectionView:this.view}),frag.appendChild(view.el)},this)),$element.append(frag)}viewMap=mapCache},clean:function(){for(var id in this.v)this.v.hasOwnProperty(id)&&(this.v[id].remove(),delete this.v[id])}}),css:makeHandler(function($element,value){$element.css(value)}),disabled:makeHandler(function($element,value){$element.prop("disabled",!!value)}),enabled:makeHandler(function($element,value){$element.prop("disabled",!value)}),html:makeHandler(function($element,value){$element.html(value)}),options:makeHandler({init:function($element,value,context,bindings){this.e=bindings.optionsEmpty,this.d=bindings.optionsDefault,this.v=bindings.value},set:function($element,value){var self=this,optionsEmpty=readAccessor(self.e),optionsDefault=readAccessor(self.d),currentValue=readAccessor(self.v),options=isCollection(value)?value.models:value,numOptions=options.length,enabled=!0,html="";numOptions||optionsDefault||!optionsEmpty?(optionsDefault&&(options=[optionsDefault].concat(options)),_.each(options,function(option,index){html+=self.opt(option,numOptions)})):(html+=self.opt(optionsEmpty,numOptions),enabled=!1),$element.html(html).prop("disabled",!enabled).val(currentValue);var revisedValue=$element.val();self.v&&!_.isEqual(currentValue,revisedValue)&&self.v(revisedValue)},opt:function(option,numOptions){var label=option,value=option,textAttr=bindingSettings.optionText,valueAttr=bindingSettings.optionValue;return isObject(option)&&(label=isModel(option)?option.get(textAttr):option[textAttr],value=isModel(option)?option.get(valueAttr):option[valueAttr]),['<option value="',value,'">',label,"</option>"].join("")},clean:function(){this.d=this.e=this.v=0}}),template:makeHandler({init:function($element,value,context){var raw=$element.find("script,template");return this.t=_.template(raw.length?raw.html():$element.html()),isArray(value)?_.pick(context,value):void 0},set:function($element,value){value=isModel(value)?value.toJSON({computed:!0}):value,$element.html(this.t(value))},clean:function(){this.t=null}}),text:makeHandler({get:function($element){return $element.text()},set:function($element,value){$element.text(value)}}),toggle:makeHandler(function($element,value){$element.toggle(!!value)}),value:makeHandler({get:function($element){return $element.val()},set:function($element,value){try{$element.val()+""!=value+""&&$element.val(value)}catch(error){}}})},bindingFilters={all:makeFilter(function(){for(var params=arguments,i=0,len=params.length;len>i;i++)if(!params[i])return!1;return!0}),any:makeFilter(function(){for(var params=arguments,i=0,len=params.length;len>i;i++)if(params[i])return!0;return!1}),length:makeFilter(function(value){return value.length||0}),none:makeFilter(function(){for(var params=arguments,i=0,len=params.length;len>i;i++)if(params[i])return!1;return!0}),not:makeFilter(function(value){return!value}),format:makeFilter(function(str){for(var params=arguments,i=1,len=params.length;len>i;i++)str=str.replace(new RegExp("\\$"+i,"g"),params[i]);return str}),select:makeFilter(function(condition,truthy,falsey){return condition?truthy:falsey}),csv:makeFilter({get:function(value){return value=String(value),value?value.split(","):[]},set:function(value){return isArray(value)?value.join(","):value}}),integer:makeFilter(function(value){return value?parseInt(value,10):0}),decimal:makeFilter(function(value){return value?parseFloat(value):0})},allowedParams={events:1,itemView:1,optionsDefault:1,optionsEmpty:1};Epoxy.binding={allowedParams:allowedParams,addHandler:function(name,handler){bindingHandlers[name]=makeHandler(handler)},addFilter:function(name,handler){bindingFilters[name]=makeFilter(handler)},config:function(settings){_.extend(bindingSettings,settings)},emptyCache:function(){bindingCache={}}};var viewMap,viewProps=["viewModel","bindings","bindingFilters","bindingHandlers","bindingSources","computeds"];return Epoxy.View=Backbone.View.extend({_super:Backbone.View,constructor:function(options){_.extend(this,_.pick(options||{},viewProps)),_super(this,"constructor",arguments),this.applyBindings()},b:function(){return this._b||(this._b=[])},bindings:"data-bind",setterOptions:null,applyBindings:function(){this.removeBindings();var self=this,sources=_.clone(_.result(self,"bindingSources")),declarations=self.bindings,options=self.setterOptions,handlers=_.clone(bindingHandlers),filters=_.clone(bindingFilters),context=self._c={};_.each(_.result(self,"bindingHandlers")||{},function(handler,name){handlers[name]=makeHandler(handler)}),_.each(_.result(self,"bindingFilters")||{},function(filter,name){filters[name]=makeFilter(filter)}),self.model=addSourceToViewContext(self,context,options,"model"),self.viewModel=addSourceToViewContext(self,context,options,"viewModel"),self.collection=addSourceToViewContext(self,context,options,"collection"),self.collection&&self.collection.view&&(self.itemView=self.collection.view),sources&&(_.each(sources,function(source,sourceName){sources[sourceName]=addSourceToViewContext(sources,context,options,sourceName,sourceName)}),self.bindingSources=sources),_.each(_.result(self,"computeds")||{},function(computed,name){var getter=isFunction(computed)?computed:computed.get,setter=computed.set,deps=computed.deps;context[name]=function(value){return!isUndefined(value)&&setter?setter.call(self,value):getter.apply(self,getDepsFromViewContext(self._c,deps))}}),isObject(declarations)?_.each(declarations,function(elementDecs,selector){var $element=queryViewForSelector(self,selector);$element.length&&bindElementToView(self,$element,elementDecs,context,handlers,filters)}):queryViewForSelector(self,"["+declarations+"]").each(function(){var $element=Backbone.$(this);bindElementToView(self,$element,$element.attr(declarations),context,handlers,filters)})},getBinding:function(attribute){return accessViewContext(this._c,attribute)},setBinding:function(attribute,value){return accessViewContext(this._c,attribute,value)},removeBindings:function(){if(this._c=null,this._b)for(;this._b.length;)this._b.pop().dispose()},remove:function(){this.removeBindings(),_super(this,"remove",arguments)}},mixins),_.extend(EpoxyBinding.prototype,Backbone.Events,{init:blankMethod,get:blankMethod,set:blankMethod,clean:blankMethod,dispose:function(){this.clean(),this.stopListening(),this.$el.off(this.evt),this.$el=this.view=null}}),Epoxy});